<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Strawberry Multiverse üçì</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Silkscreen:wght@400;700&family=Quicksand:wght@500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #ffafbd;
            --accent-red: #ff6b81;
            --deep-berry: #d81b60;
            --bg-gradient: linear-gradient(180deg, #e3f2fd 0%, #fce4ec 100%);
            --surface-white: rgba(255, 255, 255, 0.9);
            --scroll-paper: #fffcf5;
            --text-dark: #333333;
            --text-pixel: #5d4037;
            --border-soft: 6px solid white;
            --gold: #ffd700;
        }

        * { touch-action: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #1a0508; font-family: 'Quicksand', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        #game-container { width: 100vw; height: 100vh; max-width: 450px; background: var(--bg-gradient); position: relative; border: var(--border-soft); overflow: hidden; border-radius: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; z-index: 10; background: transparent; }
        .hidden { display: none !important; }
        .btn { background: var(--deep-berry); color: white; border: none; padding: 12px 20px; border-radius: 15px; font-family: 'Silkscreen'; font-size: 11px; box-shadow: 0 6px 0 #ad1457; cursor: pointer; margin: 5px; width: 85%; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #ad1457; }
        .tight-btn { width: auto !important; padding: 10px 25px !important; display: inline-block; }
        #load-bar-container { width: 80%; height: 22px; background: var(--surface-white); border-radius: 12px; border: 3px solid var(--text-pixel); overflow: hidden; margin: 20px 0; }
        #load-bar-fill { width: 0%; height: 100%; background: var(--accent-red); transition: width 0.1s linear; }
        #stats-bar { position: absolute; top: 20px; width: 100%; display: none; justify-content: space-around; z-index: 100; font-family: 'Silkscreen'; color: var(--deep-berry); }
        canvas { background: transparent; width: 100%; height: 100%; display: none; object-fit: contain; }
        #final-scroll { display: none; position: absolute; inset: 0; z-index: 1000; background: var(--scroll-paper); padding: 40px 25px; overflow-y: auto; border: 10px solid #fce4ec; transform: scale(0); transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #final-scroll.open { display: block; transform: scale(1); }
        #letter { text-align: left; font-size: 10px; line-height: 1.8; color: var(--text-dark); font-family: 'Press Start 2P', cursive; }
        .scroll-title { color: var(--accent-red); font-family: 'Fredoka One'; text-align: center; margin-bottom: 20px; font-size: 24px; }
        #memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 90%; max-width: 320px; }
        .card { aspect-ratio: 1/1; background: var(--primary-pink); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; color: transparent; border: 3px solid white; box-shadow: 0 4px 0 #ad1457; }
        .card.flipped { background: white; color: initial; transform: rotateY(180deg); }
        .card.matched { background: #e0ffe0; border-color: #90ee90; box-shadow: none; }
        #death-screen { position: absolute; inset: 0; background: rgba(26, 5, 8, 0.98); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="stats-bar"><div id="lives-ui">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>

    <div id="scr-load" class="screen">
        <div style="font-size:65px; animation: pulse 1s infinite;">üçì</div>
        <div id="percent-text" style="font-family:'Silkscreen'; color: var(--text-pixel);">0%</div>
        <div id="load-bar-container"><div id="load-bar-fill"></div></div>
        <div id="trivia-box" style="height:60px; font-size:13px; font-weight:bold; color: var(--text-pixel); font-family: 'Fredoka One';">Syncing...</div>
    </div>

    <div id="scr-title" class="screen hidden">
        <h1 style="font-family:'Fredoka One'; color: var(--accent-red); font-size: 28px;">STRAWBERRY MULTIVERSE</h1>
        <button class="btn tight-btn" onclick="startVibe()">START ADVENTURE ‚ú®</button>
        <iframe id="yt-player" width="1" height="1" src="" frameborder="0" style="visibility: hidden;"></iframe>
    </div>
    <div id="scr-gate1" class="screen hidden"><h2>DO YOU LOVE ME?</h2><button class="btn tight-btn" onclick="showScreen('scr-gate2')">YES</button><button class="btn tight-btn" onclick="showScreen('scr-gate2')">YES</button></div>
    <div id="scr-gate2" class="screen hidden"><h2>DO YOU REALLY LOVE ME?</h2><div id="gate-area-logic" style="width:100%; height:300px; position:relative; display:flex; gap:10px; align-items:center; justify-content:center;"><button id="yes-btn-3" class="btn tight-btn" onclick="handleYesSequence()">YES!</button><button id="no-run" class="btn tight-btn" onmouseover="teleportNo()" ontouchstart="teleportNo()" onclick="handleNoClick()">NO</button></div></div>

    <div id="scr-quiz" class="screen hidden"><h2 id="quiz-count" style="font-size:11px; color:var(--deep-berry);">SYNCING...</h2><p id="quiz-q" style="min-height:50px; font-weight:bold; font-size:16px; font-family: 'Fredoka One';"></p><div id="quiz-options"></div></div>

    <div id="scr-memory" class="screen hidden"><h2 style="font-family:'Fredoka One'; color: var(--accent-red);">‚ú® HEART SNAP ‚ú®</h2><div id="matches-text" style="font-family:'Silkscreen'; margin-bottom: 10px;">Matches: 0 / 6</div><div id="memory-grid"></div></div>

    <div id="scr-boss" class="screen hidden" style="padding:0;">
        <div class="hud-mini">
            <span class="flag">üá∏üá™</span>
            <div class="distance-bar-container"><div class="km-label" id="km-text">10,500 KM</div><div class="distance-fill" id="dist-fill"></div></div>
            <span class="flag">üáµüá≠</span>
        </div>
        <div id="boss-tag"><div class="boss-name" id="boss-label">VILLAIN</div><div class="hp-container"><div class="hp-fill" id="hp-fill"></div></div></div>
        <div id="bubble" class="dialog-bubble"></div>
    </div>

    <div id="final-scroll">
        <div class="scroll-title">üìú Victory for Lexi & CJ</div>
        <div id="letter"></div>
        <center>
            <div style="font-size: 30px; margin: 20px 0;">üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë©</div>
            <button onclick="location.reload()" class="btn tight-btn" style="background: var(--accent-red); border-radius:30px; font-family:'Fredoka One'; font-size: 16px;">Replay Journey</button>
        </center>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="death-screen"><h1 style="font-family:'Silkscreen';">YOU DIED</h1><div id="fill-ui"></div><p>BLOW INTO MIC!</p><button class="btn tight-btn" onclick="initMic()">REVIVE</button></div>
    <div id="ready-overlay" class="screen hidden" style="background:rgba(255,245,245,0.98); z-index:1000;"><h2 id="ready-title" style="font-family:'Fredoka One'; color: var(--accent-red);"></h2><p id="ready-instr" style="font-weight: bold;"></p><h1 id="countdown" style="font-family:'Silkscreen';">3</h1></div>
</div>

<script>
    const triviaList = ["LDR Love Language: FaceTiming until we fall asleep. üí§", "Who yaps more? Definitely one of us. üé§", "Time zones can't keep us apart! ‚è∞", "CJ + Lexi = The Ultimate Duo. üçì", "Syncing braincells in 3... 2... 1...", "Did you know CJ loves you more than iced coffee?", "Distance is just a number."];
    const quizData = [
        {q: "What‚Äôs our official LDR love language?", a: ["Virtual movie marathons.", "Yapping sessions", "Sending TikToks I‚Äôve already seen.", "Falling asleep on the phone together.", "Lablab", "All of the above (We‚Äôre obsessed)."]},
        {q: "The most flirty thing you can say to me right now is...", a: ["'I booked a flight.'", "'Check your door, I sent food.'", "I'm wearing that shirt you like.'", "Aliiiiiiiii~ <3", "None (It's actually 'I bought you a Squishmallow')."]},
        {q: "Who is the designated 'Yap-Master' during calls?", a: ["You (and it's adorable).", "Me (sorry for the 20-minute rant).", "We both fight for the mic.", "The dog that won't stop barking."]},
        {q: "What‚Äôs my favorite 'view' whilst we‚Äôre apart?", a: ["Your morning selfies.", "Your message or call notifications.", "The countdown app on my home screen.", "All (but mostly your face)."]},
        {q: "Our first physical meeting would be like...", a: ["A slow-mo movie scene.", "Pure chaos and crying.", "'Finally, I can stop smelling my screen.'", "A Pinterest board coming to life."]},
        {q: "What is the ultimate 'LDR struggle' we‚Äôve mastered?", a: ["Bad Wi-Fi during the best part.", "Time zone math (mathematician vibes).", "The 'I miss you' loop every 5 mins.", "The grumpy mode kapag gutom", "All of the above."]},
        {q: "Which red flag I‚Äôd actually ignore for you?", a: ["You leave me on read for 2 mins.", "Your music taste is interesting.", "You‚Äôre a miles-away-princess.", "None (You're a green flag with glitter)."]},
        {q: "If we were in a 'U-Haul' movie, who‚Äôs driving?", a: ["You (The Captain).", "Me (The Navigator).", "We‚Äôre both in the back with snacks.", "We aren't driving, we're already moved in."]},
        {q: "The most 'us' thing we do is...", a: ["Virtual date nights with same movie.", "TikTok shares 50x a day.", "Competitive flirting.", "All of the above."]},
        {q: "How much do I actually love you?", a: ["To the moon and back.", "More than iced coffee/strawberry.", "Enough to fight Distance Boss forever.", "All that is mentioned and more."]}
    ];

    let state = { lives: 9, stage: 'load', active: false, score: 0, pX: 225, pY: 700, bullets: [], obstacles: [], enemies: [], boss: { active: false, hp: 100, max: 100, timer: 0 }, travel: 0, currentBossStage: 0, frameCount: 0, targetX: 225, targetY: 700, qIdx: 0 };
    let gateYesClicks = 0, noClickAttempts = 0;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const distFill = document.getElementById('dist-fill'), kmText = document.getElementById('km-text'), bubble = document.getElementById('bubble'), hpFill = document.getElementById('hp-fill'), bossTag = document.getElementById('boss-tag');
    const letterContent = `Lexi, They say in most games you only get one life, but honestly? Being with you feels like a permanent power-up. Whether we‚Äôre locked in on a mission or just yapping until the stars fade into the morning, you‚Äôre the only one I want on my team. No debate.\n\nDistance is just a glitch in the system‚Äîa temporary lag spike in a connection that‚Äôs already written in the stars. My heart is permanently synced to yours. The numbers on a screen could never measure the way you make me feel; you are the only thing that feels real in this digital multiverse.\n\nYou‚Äôve guarded my heart better than any high score, and I promise to keep yours on lock forever. You aren't just my Player Two; you‚Äôre my sanctuary, my endgame, and my entire world.\n\nI‚Äôm so cooked for you, Lexi. I'm choosing you today, tomorrow, and every day after that.\n\nYours forever, CJ Morales`;

    window.onload = () => {
        canvas.width = 450; canvas.height = 800;
        let p = 0; const itv = setInterval(() => {
            p++; document.getElementById('percent-text').innerText = p+"%";
            document.getElementById('load-bar-fill').style.width = p+"%";
            if(p%14===0) document.getElementById('trivia-box').innerText = triviaList[Math.floor(p/14)%7];
            if(p>=100) { clearInterval(itv); showScreen('scr-title'); }
        }, 35);
    };

    function startVibe() { document.getElementById('yt-player').src = "https://www.youtube.com/embed/Uj93hicGDNc?autoplay=1"; showScreen('scr-gate1'); }
    function handleYesSequence() { gateYesClicks++; teleportNo(); if(gateYesClicks >= 3) startQuiz(); }
    function teleportNo() { const noBtn = document.getElementById('no-run'); noBtn.style.position = 'absolute'; const area = document.getElementById('gate-area-logic'); noBtn.style.left = Math.random()*(area.clientWidth-80)+'px'; noBtn.style.top = Math.random()*(area.clientHeight-40)+'px'; }
    function handleNoClick() { if(++noClickAttempts >= 20) { alert("Halaa di mo na ako lab? :<<"); noClickAttempts=0; } teleportNo(); }
    function startQuiz() { showScreen('scr-quiz'); renderQuiz(); }
    function renderQuiz() {
        if(state.qIdx >= 10) return startStage('harvest');
        const d = quizData[state.qIdx]; document.getElementById('quiz-count').innerText = `SYNC: ${state.qIdx+1}/10`;
        document.getElementById('quiz-q').innerText = d.q;
        const cont = document.getElementById('quiz-options'); cont.innerHTML = '';
        d.a.forEach(opt => { const b = document.createElement('button'); b.className = 'btn tight-btn'; b.innerText = opt; b.onclick = () => { state.qIdx++; renderQuiz(); }; cont.appendChild(b); });
    }

    function startStage(s) {
        state.stage = s; state.active = false; state.score = 0; state.enemies = []; state.obstacles = []; state.bullets = [];
        showScreen('ready-overlay');
        const cfg = { harvest: ["THE HARVEST", "Catch 10 Hearts! Avoid üëæ"], obby: ["THE LEAP", "Jump to CJ!"], memory: ["HEART SNAP", "Match Pairs!"], boss: ["FINAL BOSS", "Defeat Distance!"] };
        document.getElementById('ready-title').innerText = cfg[s][0];
        document.getElementById('ready-instr').innerText = cfg[s][1];
        let c = 3; document.getElementById('countdown').innerText = c;
        const itv = setInterval(() => { if(--c <= 0) { clearInterval(itv); document.getElementById('ready-overlay').classList.add('hidden'); initLogic(s); } else document.getElementById('countdown').innerText = c; }, 1000);
    }

    function initLogic(s) {
        document.getElementById('stats-bar').style.display = 'flex';
        canvas.style.display = 'block';
        if(s === 'memory') { canvas.style.display = 'none'; showScreen('scr-memory'); setupMemory(); }
        else if(s === 'boss') { showScreen('scr-boss'); state.active = true; loopBoss(); }
        else { state.active = true; state.pX = 225; requestAnimationFrame(engine); }
    }

    // --- STAGE 4 FIX: HARVEST ENGINE ---
    function engine() {
        if(!state.active || state.stage === 'boss') return;
        ctx.clearRect(0,0,450,800);
        state.frameCount++;

        if(state.stage === 'harvest') {
            // Spawn items
            if(Math.random() < 0.05) state.enemies.push({x: Math.random()*400 + 25, y: -50, t: Math.random() > 0.3 ? 'üíñ' : 'üëæ'});
            
            state.enemies.forEach((it, i) => {
                it.y += 6;
                ctx.font = "40px Arial";
                ctx.fillText(it.t, it.x - 20, it.y);
                
                // Collision
                if(it.y > 670 && it.y < 730 && Math.abs(it.x - state.pX) < 50) {
                    if(it.t === 'üíñ') state.score++; else hit();
                    state.enemies.splice(i,1);
                }
                if(it.y > 850) state.enemies.splice(i,1);
            });
            
            // Draw UI Score inside Canvas
            ctx.fillStyle = "#5d4037";
            ctx.font = "bold 20px Fredoka One";
            ctx.fillText(`Hearts: ${state.score}/10`, 20, 50);
            
            drawP("üß∫", 700);
            if(state.score >= 10) startStage('obby');
        }

        if(state.stage === 'obby') {
            ctx.font = "40px Arial"; ctx.fillText("üëß", 40, 700);
            if(state.score > 400) startStage('memory');
        }
        
        requestAnimationFrame(engine);
    }

    // Stage 7 Boss Loop
    function loopBoss() {
        if(!state.active || state.stage !== 'boss') return;
        state.frameCount++; updateBoss(); drawBoss(); requestAnimationFrame(loopBoss);
    }

    function updateBoss() {
        state.pX += (state.targetX - state.pX) * 0.15; state.pY += (state.targetY - state.pY) * 0.15;
        if(!state.boss.active) {
            state.travel += 0.085; distFill.style.width = state.travel + '%';
            kmText.innerText = Math.floor(10500 * (1 - state.travel/100)).toLocaleString() + " KM";
            if(state.travel >= 30 && state.currentBossStage === 0) startBossInstance(1, "STORM", "Lexi, you can't pass!", "‚õàÔ∏è", 250);
            if(state.travel >= 65 && state.currentBossStage === 1) startBossInstance(2, "GHOST", "7 hour gap!", "üëª", 350);
            if(state.travel >= 98 && state.currentBossStage === 2) startBossInstance(3, "WORLD", "GIVE UP!", "üåç", 650);
        }
        if(state.frameCount % 8 === 0) state.bullets.push({x: state.pX, y: state.pY, s: 16});
        state.bullets.forEach((b, i) => {
            b.y -= b.s;
            if(state.boss.active && b.y < 200 && Math.abs(b.x - 225) < 80) {
                state.boss.hp -= 5; state.bullets.splice(i, 1);
                hpFill.style.width = (state.boss.hp/state.boss.max*100) + '%';
                if(state.boss.hp <= 0) winBossInstance();
            }
        });
        if(state.boss.active && state.frameCount % 20 === 0) state.obstacles.push({x: Math.random()*450, y: 150, t: '‚ö°'});
        state.obstacles.forEach((o, i) => { o.y += 7; if(Math.hypot(state.pX-o.x, state.pY-o.y) < 35) { state.travel=Math.max(0, state.travel-2); state.obstacles.splice(i,1); } });
    }

    function startBossInstance(s, name, txt, icon, hp) {
        state.boss = { active: true, name, icon, hp, max: hp, timer: 0 };
        document.getElementById('boss-label').innerText = name;
        bossTag.style.display='flex'; bubble.style.display='block'; bubble.innerText=txt;
        bubble.style.left='135px'; bubble.style.top='200px';
    }

    function winBossInstance() {
        state.boss.active=false; bossTag.style.display='none'; bubble.style.display='none';
        if(state.currentBossStage === 2) { state.active=false; showFinalScroll(); } else state.currentBossStage++;
    }

    function drawBoss() {
        ctx.clearRect(0,0,450,800);
        state.bullets.forEach(b => { ctx.font='20px Arial'; ctx.fillText('‚ù§Ô∏è', b.x-10, b.y); });
        state.obstacles.forEach(o => { ctx.font='24px Arial'; ctx.fillText(o.t, o.x-12, o.y); });
        ctx.font='45px Arial'; ctx.fillText('üçì', state.pX-22, state.pY);
        if(state.boss.active) { ctx.font='100px Arial'; ctx.textAlign='center'; ctx.fillText(state.boss.icon, 225, 180); }
    }

    function showFinalScroll() {
        const scroll = document.getElementById('final-scroll'); scroll.style.display='block';
        setTimeout(() => scroll.classList.add('open'), 10);
        let i = 0; function type() { if(i < letterContent.length) { document.getElementById('letter').innerHTML += letterContent[i]==='\n'?'<br>':letterContent[i]; i++; setTimeout(type, 25); scroll.scrollTop=scroll.scrollHeight; } } type();
    }

    const handleInput = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        state.targetX = x; state.targetY = y; state.pX = x;
    };
    window.addEventListener('mousemove', handleInput);
    window.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e); }, { passive: false });

    function setupMemory() {
        const grid = document.getElementById('memory-grid'); const emojis = ['ü¶Ñ', 'üåà', 'üë©‚Äç‚ù§Ô∏è‚Äçüë©', 'üå∏', '‚ú®', 'üçì'];
        let cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
        grid.innerHTML = '';
        cards.forEach(emoji => {
            const card = document.createElement('div'); card.className = 'card'; card.innerText = emoji;
            card.onclick = () => {
                if(card.classList.contains('flipped') || (state.flippedCards && state.flippedCards.length >= 2)) return;
                card.classList.add('flipped'); state.flippedCards = state.flippedCards || []; state.flippedCards.push(card);
                if(state.flippedCards.length === 2) {
                    if(state.flippedCards[0].innerText === state.flippedCards[1].innerText) { state.flippedCards.forEach(c => c.classList.add('matched')); state.flippedCards = []; if(document.querySelectorAll('.matched').length === 12) startStage('boss'); }
                    else { setTimeout(() => { state.flippedCards.forEach(c => c.classList.remove('flipped')); state.flippedCards = []; }, 800); }
                }
            }; grid.appendChild(card);
        });
    }

    function drawP(e, y) { ctx.font="50px Arial"; ctx.fillText(e, state.pX-25, y); }
    function hit() { state.lives--; updateUI(); if(state.lives<=0) { state.active=false; document.getElementById('death-screen').style.display='flex'; } }
    function updateUI() { document.getElementById('lives-ui').innerText = "‚ù§Ô∏è".repeat(state.lives); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    async function initMic() { state.lives = 9; updateUI(); document.getElementById('death-screen').style.display='none'; state.active=true; if(state.stage==='boss') loopBoss(); else requestAnimationFrame(engine); }
</script>
</body>
</html>
