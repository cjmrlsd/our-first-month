<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Strawberry Multiverse üçì</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap');

        :root {
            --pink: #ffb7c5;
            --hot-pink: #ff4d6d;
            --dark-pink: #8a263a;
            --cream: #fff5f5;
        }

        * { touch-action: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #220a0e;
            font-family: 'Silkscreen', cursive;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }

        #game-container {
            width: 100%; height: 100%;
            max-width: 450px; max-height: 850px;
            background: var(--cream);
            position: relative; overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 0 20px rgba(138, 38, 58, 0.5);
            transition: transform 0.6s ease, background 1s ease;
        }

        .flipped { transform: rotate(180deg); }
        .yt-hide { position: absolute; visibility: hidden; width: 1px; height: 1px; pointer-events: none; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; z-index: 10; background: inherit; }
        .hidden { display: none !important; }

        /* Loading Feature */
        #loading-bar-container { width: 80%; height: 25px; background: #eee; border: 3px solid var(--dark-pink); border-radius: 20px; margin: 20px 0; overflow: hidden; position: relative; }
        #loading-fill { width: 0%; height: 100%; background: var(--hot-pink); transition: width 0.3s ease; }
        #loading-perc { font-size: 14px; margin-bottom: 5px; color: var(--dark-pink); }
        #loading-caption { font-size: 11px; color: var(--hot-pink); min-height: 40px; padding: 0 20px; line-height: 1.4; }

        .btn { background: var(--hot-pink); color: white; border: none; padding: 15px; border-radius: 50px; font-family: 'Silkscreen', cursive; font-size: 13px; cursor: pointer; box-shadow: 0 5px 0 var(--dark-pink); margin: 8px 0; width: 90%; position: relative; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--dark-pink); }

        #bottle-scene { position: absolute; inset: 0; z-index: 2000; background: rgba(255, 245, 245, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; }
        #the-bottle { font-size: 120px; transition: transform 0.1s; user-select: none; }
        #letter-overlay { position: absolute; inset: 5%; background: #fffafa; border: 4px solid var(--hot-pink); border-radius: 20px; padding: 20px; z-index: 5000; overflow-y: auto; display: none; flex-direction: column; }
        #boss-bubble { position: absolute; top: 110px; left: 50%; transform: translateX(-50%); background: white; border: 3px solid var(--dark-pink); padding: 10px; border-radius: 15px; width: 85%; font-size: 11px; z-index: 50; display: none; }
        #ui-layer { position:absolute; top:20px; left:20px; display:none; z-index:100; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="player-chill" class="yt-hide"></div>
    <div id="player-boss" class="yt-hide"></div>
    <div id="player-win" class="yt-hide"></div>

    <div id="music-toggle" onclick="toggleMusic()" style="position: absolute; top: 20px; right: 20px; z-index: 1000; background: white; border: 2px solid var(--hot-pink); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer;">üéµ</div>
    
    <div id="ui-layer">
        <div id="heart-bar">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="score-text" style="font-size: 12px; margin-top: 5px; color: var(--dark-pink);">STRAWBERRIES: 0</div>
    </div>

    <div id="scr-loading" class="screen">
        <div style="font-size: 50px;">üçì</div>
        <h2 style="font-size: 18px;">SYNCING THE MULTIVERSE...</h2>
        <div id="loading-perc">0%</div>
        <div id="loading-bar-container"><div id="loading-fill"></div></div>
        <div id="loading-caption">Finding the perfect strawberries for Lexi...</div>
    </div>

    <div id="scr-intro" class="screen hidden">
        <div style="font-size: 60px;">üçì</div>
        <h1>STRAWBERRY<br>MULTIVERSE</h1>
        <button class="btn" onclick="startAdventure()">ENTER MULTIVERSE</button>
    </div>

    <div id="scr-love1" class="screen hidden">
        <h1>DO YOU<br>LOVE ME?</h1>
        <button class="btn" onclick="goToLove2()">YES!</button>
        <button id="no-btn-1" class="btn no-run" style="position:absolute;">NO</button>
    </div>

    <div id="scr-love2" class="screen hidden">
        <h1>DO YOU<br>REALLY LOVE ME?</h1>
        <button class="btn" onclick="nextLevel()">YES!</button>
        <button id="no-btn-2" class="btn no-run" style="position:absolute;">NO</button>
    </div>

    <div id="instruction-screen" class="screen hidden">
        <h2 id="ins-title"></h2>
        <p id="ins-text" style="font-size: 14px;"></p>
        <button class="btn" onclick="startActualLvl()">SHE'S READY!</button>
    </div>

    <canvas id="mainCanvas" style="display:none; width:100%; height:100%;"></canvas>
    <div id="boss-bubble"></div>

    <div id="bottle-scene">
        <h2 style="font-size: 16px;">THE DISTANCE DROPPED SOMETHING!</h2>
        <div id="the-bottle" onclick="pickUpBottle()">üçº</div>
        <div id="progress-container" class="hidden" style="width:70%; height:20px; background:#eee; border-radius:10px; border:3px solid var(--dark-pink); overflow:hidden; margin-top:20px;">
            <div id="progress-bar" style="width:0%; height:100%; background:var(--hot-pink);"></div>
        </div>
        <p id="rub-text" class="hidden" style="font-size: 12px; margin-top:10px;">RUB THE BOTTLE TO OPEN!</p>
    </div>

    <div id="letter-overlay">
        <h2 style="color:var(--dark-pink);">Happy Monthsary Aliii! üçì</h2>
        <p style="font-family:sans-serif; line-height:1.6; color:var(--dark-pink);">Lexi, you've defeated the distance! Every strawberry proved our love is stronger than any multiverse. <br><br>I love you forever!<br>- CJ</p>
        <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // --- Audio Manager ---
    const AudioMgr = {
        ctx: null,
        isMuted: false,
        init() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        },
        play(type) {
            if (this.isMuted || !this.ctx) return;
            if (this.ctx.state === 'suspended') this.ctx.resume();
            
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            const now = this.ctx.currentTime;

            switch(type) {
                case 'click':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'collect': // Coin sound
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now); // C5
                    osc.frequency.exponentialRampToValueAtTime(783.99, now + 0.1); // G5
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;
                case 'hit': // Thud
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(40, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'dead': // Pitch shift down
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                    break;
            }
        }
    };

    // --- YouTube Controller ---
    let players = {};
    let readyCount = 0;
    function onYouTubeIframeAPIReady() {
        players.chill = new YT.Player('player-chill', { height: '0', width: '0', videoId: 'Uj93hicGDNc', playerVars: { 'loop': 1, 'playlist': 'Uj93hicGDNc' }, events: { 'onReady': onTrackReady }});
        players.boss = new YT.Player('player-boss', { height: '0', width: '0', videoId: '8p_O5H6h3O0', playerVars: { 'loop': 1, 'playlist': '8p_O5H6h3O0' }, events: { 'onReady': onTrackReady }});
        players.win = new YT.Player('player-win', { height: '0', width: '0', videoId: '3GwjfUFyY6M', playerVars: { 'loop': 1, 'playlist': '3GwjfUFyY6M' }, events: { 'onReady': onTrackReady }});
    }

    function onTrackReady() {
        readyCount++;
        if(readyCount === 3) startLoadingBar();
    }

    // --- Game Logic ---
    const state = { level: 0, hearts: 5, score: 0, frames: 0, objects: [], isPaused: true, player: { x: 200, targetX: 200, speedMult: 0.18 }};
    const captions = ["Fun Fact: Distance makes the gay heart grow fonder. üåà", "Waiting for the music... and our next hug.", "Lexi + CJ = Endgame. üçì", "WLW Pro-tip: Video calls count as real dates! üì±‚ú®"];

    function startLoadingBar() {
        let loadPerc = 0;
        const interval = setInterval(() => {
            loadPerc += Math.random() * 15;
            if(loadPerc >= 100) {
                loadPerc = 100;
                clearInterval(interval);
                document.getElementById('scr-loading').classList.add('hidden');
                document.getElementById('scr-intro').classList.remove('hidden');
            }
            document.getElementById('loading-fill').style.width = loadPerc + "%";
            document.getElementById('loading-perc').innerText = Math.floor(loadPerc) + "%";
            if(Math.floor(loadPerc) % 30 === 0) document.getElementById('loading-caption').innerText = captions[Math.floor(Math.random()*captions.length)];
        }, 200);
    }

    function toggleMusic() {
        AudioMgr.isMuted = !AudioMgr.isMuted;
        document.getElementById('music-toggle').innerText = AudioMgr.isMuted ? "üîá" : "üéµ";
        Object.values(players).forEach(p => AudioMgr.isMuted ? p.pauseVideo() : null);
        if(!AudioMgr.isMuted) switchBGM();
    }

    function switchBGM() {
        if(AudioMgr.isMuted) return;
        Object.values(players).forEach(p => p.pauseVideo());
        if(state.level < 4) players.chill.playVideo();
        else if(state.level === 4) players.boss.playVideo();
        else players.win.playVideo();
    }

    function startAdventure() {
        AudioMgr.init();
        AudioMgr.play('click');
        switchBGM();
        document.getElementById('scr-intro').classList.add('hidden');
        document.getElementById('scr-love1').classList.remove('hidden');
    }

    function goToLove2() { AudioMgr.play('click'); document.getElementById('scr-love1').classList.add('hidden'); document.getElementById('scr-love2').classList.remove('hidden'); }

    function nextLevel() {
        AudioMgr.play('click');
        state.level++;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('mainCanvas').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('boss-bubble').style.display = 'none';
        
        if(state.level === 4 || state.level === 5) switchBGM();
        if(state.level === 5) { document.getElementById('bottle-scene').style.display = 'flex'; return; }

        const data = [null, {t: "LVL 1: SYNC", d: "Sync her heart with CJ's!"}, {t: "LVL 2: HARVEST", d: "Catch 15 strawberries! Avoid üíî."}, {t: "LVL 3: THE FLIP", d: "Everything is upside down!"}, {t: "FINAL BOSS", d: "DISTANCE: 'She'll never reach him!'" }][state.level];
        const ins = document.getElementById('instruction-screen');
        ins.classList.remove('hidden');
        document.getElementById('ins-title').innerText = data.t;
        document.getElementById('ins-text').innerText = data.d;
    }

    function startActualLvl() {
        AudioMgr.play('click');
        document.getElementById('instruction-screen').classList.add('hidden');
        document.getElementById('ui-layer').style.display = 'block';
        state.isPaused = false;
        state.score = 0; state.frames = 0; state.objects = [];
        if(state.level === 3) document.getElementById('game-container').classList.add('flipped');
        if(state.level === 4) document.getElementById('boss-bubble').style.display = 'block';
        document.getElementById('mainCanvas').style.display = 'block';
        updateUI();
        runGameLoop();
    }

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 450; canvas.height = 850;

    function runGameLoop() {
        if(state.isPaused || state.level < 2 || state.level > 4) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        state.player.x += (state.player.targetX - state.player.x) * 0.18;

        if(state.frames % 30 === 0) {
            state.objects.push({x: Math.random()*(canvas.width-40), y:-50, t: (state.level === 4 && Math.random()>0.4?'üíî':'üçì')});
        }
        
        state.objects.forEach((o, i) => {
            o.y += 6;
            ctx.font = "45px Arial"; ctx.fillText(o.t, o.x, o.y);
            // Optimized Collision
            if(o.y > canvas.height - 110 && o.y < canvas.height - 20 && Math.abs(o.x - state.player.x) < 90) {
                if(o.t === 'üçì') { state.score++; AudioMgr.play('collect'); } 
                else { state.hearts--; AudioMgr.play('hit'); }
                state.objects.splice(i, 1);
                updateUI();
            }
            if(o.y > canvas.height) state.objects.splice(i, 1);
        });
        
        ctx.font = "80px Arial"; ctx.fillText("üß∫", state.player.x - 40, canvas.height - 50);
        state.frames++;

        if(state.hearts <= 0) { 
            AudioMgr.play('dead'); 
            state.hearts = 5; state.score = 0; state.objects = []; 
            updateUI(); 
        }

        if(state.score >= (state.level === 4 ? 30 : 15)) nextLevel();
        else requestAnimationFrame(runGameLoop);
    }

    function updateUI() {
        document.getElementById('heart-bar').innerText = "‚ù§Ô∏è".repeat(Math.max(0, state.hearts));
        document.getElementById('score-text').innerText = state.level === 4 ? "WILLPOWER: " + state.score + "/30" : `STRAWBERRIES: ${state.score}/15`;
    }

    function pickUpBottle() {
        AudioMgr.play('click');
        document.getElementById('progress-container').classList.remove('hidden');
        document.getElementById('rub-text').classList.remove('hidden');
        document.getElementById('the-bottle').innerText = "üçæ";
        let cleanProgress = 0;
        const rub = () => {
            if(cleanProgress < 100) {
                cleanProgress += 1.5;
                document.getElementById('progress-bar').style.width = cleanProgress + "%";
                if(cleanProgress >= 100) {
                    AudioMgr.play('collect');
                    document.getElementById('bottle-scene').style.display = 'none';
                    document.getElementById('letter-overlay').style.display = 'flex';
                }
            }
        };
        window.addEventListener('touchmove', rub);
    }

    canvas.addEventListener('touchmove', (e) => {
        let rect = canvas.getBoundingClientRect();
        state.player.targetX = e.touches[0].clientX - rect.left;
    });

    document.querySelectorAll('.no-run').forEach(btn => {
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            btn.style.left = Math.random()*70+'%'; btn.style.top = Math.random()*70+'%';
        });
    });

    // Button sound wrapper
    document.querySelectorAll('.btn').forEach(b => b.addEventListener('mousedown', () => AudioMgr.play('click')));
</script>
</body>
</html>
